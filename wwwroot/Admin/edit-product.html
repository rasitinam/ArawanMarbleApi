<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Edit Product - ArawanPanel</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600">
    <link rel="stylesheet" href="css/fontawesome.min.css">
    <link rel="stylesheet" href="jquery-ui-datepicker/jquery-ui.min.css" type="text/css" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body class="bg02">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav class="navbar navbar-expand-xl navbar-light bg-light">
                    <a class="navbar-brand" href="index.html">
                        <i class="fas fa-3x fa-tachometer-alt tm-site-icon"></i>
                        <h1 class="tm-site-title mb-0">ArawanPanel</h1>
                    </a>
                    <button class="navbar-toggler ml-auto mr-0" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                            aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav mx-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="index.html">Dashboard</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="products.html">Products</a>
                            </li>
                        </ul>
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link d-flex" href="login.html">
                                    <i class="far fa-user mr-2 tm-logout-icon"></i>
                                    <span>Logout</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>

        <div class="row tm-mt-big">
            <div class="col-xl-8 col-lg-10 col-md-12 col-sm-12">
                <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-12">
                            <h2 class="tm-block-title d-inline-block">Edit Product</h2>
                        </div>
                    </div>
                    <div class="row mt-4 tm-edit-product-row">
                        <div class="col-xl-7 col-lg-7 col-md-12">
                            <form id="editProductForm" class="tm-edit-product-form">
                                <div class="input-group mb-3">
                                    <label for="name" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 col-form-label">Product Name</label>
                                    <input placeholder="Product name" id="name" name="name" type="text" class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7">
                                </div>
                                <div class="input-group mb-3">
                                    <label for="description" class="col-xl-4 col-lg-4 col-md-4 col-sm-5 mb-2">Description</label>
                                    <textarea class="form-control validate col-xl-9 col-lg-8 col-md-8 col-sm-7" rows="3" placeholder="Product Description" required id="description"></textarea>
                                </div>
                                <div class="input-group mb-3">
                                    <div class="ml-auto col-xl-8 col-lg-8 col-md-8 col-sm-7 pl-0">
                                        <button type="submit" class="btn btn-primary">Update</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-xl-4 col-lg-4 col-md-12 mx-auto mb-4">
                            <img id="productImage" alt="Product Image" class="img-fluid d-none" style="max-height: 200px;" />
                            <div class="custom-file mt-3 mb-3">
                                <input id="fileInput" type="file" style="display:none;" />
                                <input type="button" class="btn btn-primary d-block mx-auto" value="Upload ..." onclick="document.getElementById('fileInput').click();" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="row tm-mt-big">
            <div class="col-12 font-weight-light">
                <p class="d-inline-block tm-bg-black text-white py-2 px-4">
                    Copyright &copy; 2025 Admin Dashboard . Created by
                    <a rel="nofollow" href="https://www.linkedin.com/in/meriç-orhay-a1a9b016a/" class="text-white tm-footer-link">Meriç Orhay</a> &
                    <a rel="nofollow" href="https://www.linkedin.com/in/raşit-inam-05a128298/" class="text-white tm-footer-link">Raşit İnam</a>
                </p>
            </div>
        </footer>
    </div>

    <script>
        let selectedImageFile = null;

        // URL'den ID'yi al
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const productId = getQueryParam("id");

        // Veri çek ve forma yerleştir
        if (productId) {
            fetch(`/api/products/${productId}`)
                .then(res => res.json())
                .then(product => {
                    document.getElementById("name").value = product.productname || "";
                    document.getElementById("description").value = product.description || "";

                    const imageEl = document.getElementById("productImage");

                    if (product.productimg) {
                        imageEl.src = product.productimg;
                        imageEl.classList.remove("d-none");
                    } else {
                        imageEl.classList.add("d-none");
                    }
                })
                .catch(err => console.error("Veri alınırken hata:", err));
        }

        // Resim yükleme ön izleme
        document.getElementById("fileInput").addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (file) {
                selectedImageFile = file;
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imageEl = document.getElementById("productImage");
                    imageEl.src = e.target.result;
                    imageEl.classList.remove("d-none");
                };
                reader.readAsDataURL(file);
            }
        });

        // Form submit olunca güncelleme işlemi
        document.getElementById("editProductForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append("ProductName", document.getElementById("name").value);
            formData.append("Description", document.getElementById("description").value);

            if (selectedImageFile) {
                formData.append("ProductImage", selectedImageFile);  // Resmi ekle
            }

            fetch(`/api/Products/${productId}`, {
                method: "PUT",
                body: formData  // FormData kullanıyoruz, başlıkları otomatik olarak ayarlıyor
            })
                .then(response => {
                    if (response.ok) {
                        alert("Ürün başarıyla güncellendi!");
                        window.location.href = "products.html";
                    } else {
                        alert("Güncelleme başarısız oldu.");
                    }
                })
                .catch(error => {
                    console.error("PUT isteği hatası:", error);
                });
        });


    </script>


    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="jquery-ui-datepicker/jquery-ui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
        $(function () {
            $('#expire_date').datepicker();
        });
    </script>
</body>

</html>
